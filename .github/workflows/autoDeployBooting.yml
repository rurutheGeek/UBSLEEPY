name: bootingRaspi
on:
  push:
    branches: 
      - main
  workflow_dispatch:
jobs:
  deploy:
    name: booting
    runs-on: [self-hosted, linux, ARM64]
    steps:
      - name: Check user permission
        run: |
          #!/bin/sh
          if [ "$GITHUB_ACTOR" != "rurutheGeek" ]; then
              echo "You are not authorized to run this workflow."
              exit 1
          fi
      - uses: actions/checkout@v2
      - name: Install tmux if not present
        run: |
          #!/bin/sh
          if ! command -v tmux &> /dev/null; then
              echo "tmux is not installed. Installing..."
              sudo apt-get update
              sudo apt-get install -y tmux
              echo "tmux installed successfully."
          else
              echo "tmux is already installed."
          fi
      - name: deploy
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        run: |
          #!/bin/sh
          
          echo ...UBSLEEPY deploying...
          cd /home/ruru/UBSLEEPY/
          git reset --hard
          git --git-dir=.git pull origin main
          echo pull ok.
          
          echo ...UBSLEEPY restarting...
          if pgrep -f "main.py" > /dev/null; then
              pkill -f "main.py"
              echo killed.
          else
              echo not killed.
          fi
          
          # すでに存在するtmuxセッションを終了
          tmux kill-session -t discord_bot 2>/dev/null || true
          
          # 新しいtmuxセッションを作成して、その中でボットを実行
          tmux new-session -d -s discord_bot "DISCORD_TOKEN=$DISCORD_TOKEN python3 main.py | tee -a log/console_output.log"
          
          echo "Bot started in tmux session 'discord_bot'"
          echo "To view bot console, connect to the Raspberry Pi and run: tmux attach -t discord_bot"
          echo boot ok.
